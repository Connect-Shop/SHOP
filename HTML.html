<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Game & IT Store</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Google Fonts (Prompt) -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-body-dark: #181a20;
      --bg-card-dark: #212529;
      --bg-input-dark: #2b3035;
      --border-color-dark: #383d42;
      --primary-blue: #4facfe;
      --text-gray: #adb5bd;
      --text-white: #ffffff;
    }

    body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; color: #333; }
    
    /* Shop UI Styles */
    .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .card-zoom:hover img { transform: scale(1.1); }
    .card-zoom img { transition: transform 0.3s ease; }
    .loader { border-top-color: #3B82F6; animation: spinner 1s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Modal & Input Styles (Fix Zoom) */
    .app-container {
        width: 100%; max-width: 480px; background-color: var(--bg-card-dark);
        min-height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    @media (min-width: 640px) {
        .app-container { min-height: auto; height: 650px; border-radius: 16px; }
    }

    input, select, textarea { font-size: 16px !important; }

    .seagm-input-group { position: relative; margin-bottom: 16px; }
    .seagm-input {
        width: 100%; background-color: var(--bg-input-dark); border: 1px solid var(--border-color-dark);
        border-radius: 6px; padding: 12px 12px 12px 45px; color: white; font-size: 16px; transition: all 0.2s; outline: none;
    }
    .seagm-input.has-btn { padding-right: 100px; }
    .search-input {
        width: 100%; background-color: #181a20; border: 1px solid var(--border-color-dark);
        border-radius: 6px; padding: 10px 10px 10px 40px; color: white; font-size: 16px; outline: none;
    }
    .seagm-input:focus, .search-input:focus, .seagm-select:focus { border-color: var(--primary-blue); }
    
    /* New Select Style */
    .seagm-select {
        width: 100%; background-color: var(--bg-input-dark); border: 1px solid var(--border-color-dark);
        border-radius: 6px; padding: 12px 12px 12px 12px; color: white; font-size: 16px; outline: none;
        appearance: none; cursor: pointer;
    }
    .select-wrapper { position: relative; margin-bottom: 16px; }
    .select-wrapper::after {
        content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
        position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
        color: #6c757d; pointer-events: none; font-size: 12px;
    }

    .input-icon {
        position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
        color: #6c757d; font-size: 16px; width: 20px; text-align: center;
    }

    .btn-primary-dark {
        background-color: var(--primary-blue); color: white; border-radius: 6px;
        padding: 12px; width: 100%; font-weight: 600; border: none; font-size: 16px;
        transition: 0.2s; cursor: pointer; margin-top: 10px;
    }
    .btn-otp {
        position: absolute; right: 6px; top: 6px; bottom: 6px;
        background-color: rgba(79, 172, 254, 0.1); color: var(--primary-blue);
        border: 1px solid rgba(79, 172, 254, 0.3); border-radius: 4px; padding: 0 12px;
        font-size: 14px; font-weight: 500; cursor: pointer; transition: 0.2s;
    }
    
    .country-selector {
        background-color: var(--bg-input-dark); border: 1px solid var(--border-color-dark);
        border-radius: 6px; padding: 10px 15px; display: flex; align-items: center;
        justify-content: space-between; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
    }
    .country-modal {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: var(--bg-card-dark); z-index: 100;
        transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
    }
    .country-modal.open { transform: translateX(0); }
    .country-list-item {
        display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #2b3035;
        cursor: pointer; transition: background 0.2s;
    }
    .country-list-item:hover { background-color: #2b3035; }

    .tab-container { display: flex; border-bottom: 1px solid var(--border-color-dark); margin-bottom: 20px; }
    .tab-item {
        flex: 1; text-align: center; padding: 12px; font-size: 15px;
        color: var(--text-gray); cursor: pointer; border-bottom: 2px solid transparent; transition: 0.3s;
    }
    .tab-item.active { color: white; border-bottom: 2px solid var(--primary-blue); font-weight: 500; }
    
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Loading Screen -->
  <div id="loadingOverlay" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-white transition-opacity duration-500">
    <div class="mb-4 text-4xl text-blue-600"><i class="fa-solid fa-gamepad fa-bounce"></i></div>
    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-4"></div>
    <h2 class="text-gray-500 text-sm animate-pulse">กำลังโหลดร้านค้า...</h2>
  </div>

  <!-- Navbar -->
  <nav class="fixed w-full z-40 top-0 glass-nav">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-2 cursor-pointer" onclick="window.scrollTo(0,0)">
          <div class="bg-blue-600 text-white p-2 rounded-lg shadow-md"><i class="fa-solid fa-bolt"></i></div>
          <span class="font-bold text-xl text-gray-800 tracking-tight">G-STORE</span>
        </div>
        
        <div class="flex items-center space-x-4">
          <div id="guestMenu">
            <button onclick="openAuthModal()" class="bg-black text-white px-5 py-2 rounded-full font-medium text-sm hover:bg-gray-800 transition shadow-lg">
              <i class="fa-regular fa-user mr-2"></i>เข้าสู่ระบบ
            </button>
          </div>
          <div id="userMenu" class="hidden flex items-center bg-gray-100 rounded-full px-4 py-1.5 space-x-3 border border-gray-200">
            <div class="flex flex-col items-end leading-tight">
              <span class="text-xs text-gray-500">สวัสดี</span>
              <span class="text-sm font-bold text-blue-600 truncate max-w-[100px]" id="userNameDisplay">User</span>
            </div>
            <button onclick="logout()" class="w-8 h-8 rounded-full bg-white text-red-500 hover:bg-red-50 shadow flex items-center justify-center">
              <i class="fa-solid fa-power-off"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="pt-24 pb-12 px-4 max-w-7xl mx-auto min-h-screen">
    <!-- Banner -->
    <div class="relative rounded-2xl overflow-hidden shadow-2xl mb-10 group h-48 md:h-80">
      <img src="https://images.unsplash.com/photo-1542751371-adc38448a05e?w=1200" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent flex flex-col justify-end p-6 md:p-10">
        <span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded w-max mb-2">NEW ARRIVAL</span>
        <h1 class="text-white text-2xl md:text-5xl font-bold mb-2">เติมเกมส์ & ไอที ครบวงจร</h1>
        <p class="text-gray-200 text-sm md:text-lg">ปลอดภัย 100% รับประกันสินค้าทุกชิ้น</p>
      </div>
    </div>
    <!-- Products -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-6">สินค้าแนะนำ</h2>
      <div id="productGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    </div>
    <!-- Games -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-purple-600 pl-3 mb-6">เติมเกมส์ออนไลน์</h2>
      <div id="gameGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeAuthModal()"></div>
    
    <div class="flex items-center justify-center min-h-screen p-0 sm:p-4 pointer-events-none">
      <div class="app-container pointer-events-auto shadow-2xl transform transition-all">
        
        <!-- Header -->
        <header class="flex justify-between items-center p-4 border-b border-[#383d42] bg-[#212529]/95 backdrop-blur sticky top-0 z-50">
           <div class="flex items-center">
             <button onclick="closeAuthModal()" class="mr-3 text-gray-400 hover:text-white sm:hidden"><i class="fa-solid fa-arrow-left"></i></button>
             <h1 class="text-lg font-bold italic tracking-wide text-white" id="page-title">เข้าสู่ระบบ</h1>
           </div>
           <div class="flex items-center gap-2">
             <button onclick="toggleMainView()" class="text-xs text-white border border-[#495057] px-3 py-1.5 rounded bg-[#2b3035] hover:border-[#adb5bd] transition">
                 <span id="switch-btn-text">สมัครสมาชิก</span>
             </button>
             <button onclick="closeAuthModal()" class="text-gray-400 hover:text-white ml-2 hidden sm:block"><i class="fa-solid fa-xmark text-xl"></i></button>
           </div>
        </header>

        <div class="p-5 flex-1 overflow-y-auto custom-scrollbar">

            <!-- LOGIN VIEW -->
            <div id="view-login" class="fade-in">
                <!-- Tabs -->
                <div class="tab-container">
                    <div id="tab-login-main" class="tab-item active" onclick="switchLoginTab('main')">รหัสผ่าน</div>
                    <div id="tab-login-otp" class="tab-item" onclick="switchLoginTab('otp')">อีเมล OTP</div>
                </div>

                <!-- LOGIN TAB: MAIN (Email/User/Phone + Password) -->
                <div id="form-login-main" class="fade-in">
                    
                    <!-- INPUT SELECT: Method Choice -->
                    <div class="select-wrapper">
                        <select id="login-method-select" class="seagm-select" onchange="toggleLoginMethod()">
                            <option value="email">อีเมล / ชื่อผู้ใช้</option>
                            <option value="phone">เบอร์โทรศัพท์มือถือ</option>
                        </select>
                    </div>

                    <!-- Input: Email/User -->
                    <div id="input-group-email" class="seagm-input-group">
                        <i class="fa-solid fa-user input-icon"></i>
                        <input type="text" id="login-username" class="seagm-input" placeholder="อีเมล หรือ ชื่อผู้ใช้">
                    </div>

                    <!-- Input: Phone (Hidden by default) -->
                    <div id="input-group-phone" class="hidden">
                        <div class="country-selector group" onclick="openCountryModal('login')">
                            <div class="flex items-center gap-3">
                                <img id="login-selected-flag" src="https://flagcdn.com/w40/th.png" alt="TH" class="w-6 h-4 rounded-sm object-cover shadow-sm">
                                <span id="login-selected-code" class="text-white font-medium text-sm">+66</span>
                                <span id="login-selected-name" class="text-[#adb5bd] text-sm border-l border-[#383d42] pl-3 ml-1 group-hover:text-white transition">Thailand</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-[#6c757d] text-xs"></i>
                        </div>
                        <div class="seagm-input-group">
                            <i class="fa-solid fa-mobile-screen input-icon"></i>
                            <input type="tel" id="login-phone" class="seagm-input" placeholder="หมายเลขโทรศัพท์">
                        </div>
                    </div>

                    <!-- Input: Password (Shared) -->
                    <div class="seagm-input-group">
                        <i class="fa-solid fa-lock input-icon"></i>
                        <input type="password" id="login-pass" class="seagm-input" placeholder="รหัสผ่าน">
                        <i class="fa-solid fa-eye absolute right-4 top-1/2 -translate-y-1/2 text-[#6c757d] cursor-pointer hover:text-white transition" onclick="togglePass('login-pass')"></i>
                    </div>

                    <button class="btn-primary-dark" onclick="submitLogin()">เข้าสู่ระบบ</button>
                </div>

                <!-- LOGIN TAB: OTP -->
                <div id="form-login-otp" class="hidden fade-in">
                    <div class="seagm-input-group">
                        <i class="fa-solid fa-envelope input-icon"></i>
                        <input type="email" id="login-otp-email" class="seagm-input" placeholder="กรอกอีเมลของคุณ">
                    </div>
                    <div class="seagm-input-group">
                        <i class="fa-solid fa-shield-halved input-icon"></i>
                        <input type="text" id="login-otp-code" class="seagm-input has-btn" placeholder="รหัส OTP 6 หลัก" maxlength="6">
                        <button class="btn-otp" onclick="requestOtp('login-otp-email', this)">ส่งรหัสยืนยัน</button>
                    </div>
                    <button class="btn-primary-dark mt-6" onclick="submitLoginOtp()">เข้าสู่ระบบ</button>
                </div>

                <div class="mt-8 text-center">
                    <div class="flex items-center mb-6">
                        <div class="flex-1 h-px bg-[#383d42]"></div>
                        <span class="px-3 text-xs text-[#6c757d]">เชื่อมต่อด้วย Line OA</span>
                        <div class="flex-1 h-px bg-[#383d42]"></div>
                    </div>
                    <button class="w-12 h-12 rounded-full bg-[#00c300] text-white inline-flex items-center justify-center hover:opacity-90 shadow-lg">
                        <i class="fa-brands fa-line text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- REGISTER VIEW -->
            <div id="view-register" class="hidden fade-in">
                <div class="mb-6 text-center">
                    <p class="text-sm text-[#adb5bd]">สร้างบัญชีใหม่เพื่อเข้าถึงบริการทั้งหมด</p>
                </div>
                <div class="seagm-input-group">
                    <i class="fa-solid fa-envelope input-icon"></i>
                    <input type="email" id="reg-email" class="seagm-input" placeholder="อีเมล">
                </div>
                <div class="seagm-input-group">
                    <i class="fa-brands fa-line input-icon"></i>
                    <input type="text" id="reg-line" class="seagm-input" placeholder="Line ID">
                </div>
                <div class="mb-4">
                    <div class="country-selector group" onclick="openCountryModal('register')">
                        <div class="flex items-center gap-3">
                            <img id="reg-selected-flag" src="https://flagcdn.com/w40/th.png" alt="TH" class="w-6 h-4 rounded-sm object-cover shadow-sm">
                            <span id="reg-selected-code" class="text-white font-medium text-sm">+66</span>
                            <span id="reg-selected-name" class="text-[#adb5bd] text-sm border-l border-[#383d42] pl-3 ml-1 group-hover:text-white transition">Thailand</span>
                        </div>
                        <i class="fa-solid fa-chevron-right text-[#6c757d] text-xs"></i>
                    </div>
                    <div class="seagm-input-group">
                        <i class="fa-solid fa-mobile-screen input-icon"></i>
                        <input type="tel" id="reg-phone" class="seagm-input" placeholder="หมายเลขโทรศัพท์">
                    </div>
                </div>
                <div class="seagm-input-group">
                    <i class="fa-solid fa-shield-halved input-icon"></i>
                    <input type="text" id="reg-otp" class="seagm-input has-btn" placeholder="รหัส OTP" maxlength="6">
                    <button class="btn-otp" onclick="requestOtp('reg-email', this)">ส่งรหัส</button>
                </div>
                <div class="seagm-input-group">
                    <i class="fa-solid fa-lock input-icon"></i>
                    <input type="password" id="reg-pass" class="seagm-input" placeholder="ตั้งรหัสผ่าน">
                    <i class="fa-solid fa-eye absolute right-4 top-1/2 -translate-y-1/2 text-[#6c757d] cursor-pointer hover:text-white transition" onclick="togglePass('reg-pass')"></i>
                </div>
                <button class="btn-primary-dark mt-4" onclick="submitRegister()">สมัครสมาชิก</button>
            </div>
        </div>

        <!-- FULL COUNTRY LIST MODAL -->
        <div id="country-modal" class="country-modal">
            <div class="flex justify-between items-center p-4 border-b border-[#383d42] bg-[#212529]">
                <button onclick="closeCountryModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                <span class="font-medium text-white">เลือกประเทศ</span>
                <div class="w-6"></div>
            </div>
            <div class="p-3 bg-[#212529] border-b border-[#383d42]">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></i>
                    <input type="text" id="search-country" class="search-input" placeholder="ค้นหาประเทศ..." onkeyup="filterCountries()">
                </div>
            </div>
            <div id="country-list-container" class="flex-1 overflow-y-auto custom-scrollbar"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- Data & State ---
    const allCountries = [
        { code: "TH", name: "Thailand", dial_code: "+66" },
        { code: "LA", name: "Laos", dial_code: "+856" },
        { code: "VN", name: "Vietnam", dial_code: "+84" },
        { code: "US", name: "United States", dial_code: "+1" },
        { code: "GB", name: "United Kingdom", dial_code: "+44" },
        { code: "JP", name: "Japan", dial_code: "+81" },
        { code: "KR", name: "South Korea", dial_code: "+82" },
        { code: "CN", name: "China", dial_code: "+86" },
        { code: "MM", name: "Myanmar", dial_code: "+95" },
        { code: "KH", name: "Cambodia", dial_code: "+855" }
    ];
    let currentUser = null;
    let isLoginView = true;
    let currentCountryContext = 'register'; // 'register' or 'login'

    // --- Init ---
    window.onload = function() {
        google.script.run.withSuccessHandler(renderShop).getShopData();
    };

    function renderShop(data) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('productGrid').innerHTML = data.products.map(p => `
            <div class="bg-white rounded-xl shadow hover:shadow-lg transition overflow-hidden card-zoom border border-gray-100 flex flex-col h-full">
                <div class="h-36 overflow-hidden relative bg-gray-100"><img src="${p.image}" class="w-full h-full object-cover">
                ${p.discount > 0 ? `<div class="absolute top-2 right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded">- ${p.discount}</div>` : ''}</div>
                <div class="p-3 flex-1 flex flex-col justify-between"><div><h3 class="font-bold text-gray-800 text-sm truncate">${p.name}</h3><p class="text-xs text-gray-500 mt-1 line-clamp-1">${p.detail}</p></div>
                <div class="mt-2 pt-2 border-t border-gray-100"><div class="flex justify-between items-end mb-2"><span class="text-blue-600 font-bold text-sm">฿${(p.price - p.discount).toLocaleString()}</span><span class="text-[10px] text-gray-400 line-through">฿${p.price.toLocaleString()}</span></div><button onclick="buyItem('${p.name}')" class="w-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white text-xs font-bold py-1.5 rounded transition">สั่งซื้อ</button></div></div>
            </div>`).join('');
        document.getElementById('gameGrid').innerHTML = data.games.map(g => `
            <div class="bg-white rounded-xl shadow hover:shadow-lg transition overflow-hidden card-zoom border border-gray-100 flex flex-col h-full">
                <div class="h-36 overflow-hidden relative bg-gray-100"><img src="${g.image}" class="w-full h-full object-cover"></div>
                <div class="p-3 flex-1 flex flex-col justify-between"><div><h3 class="font-bold text-gray-800 text-sm truncate">${g.name}</h3><p class="text-xs text-purple-600 font-medium mt-1"><i class="fa-solid fa-gem mr-1"></i>${g.items}</p>${g.freeItem != '-' ? `<p class="text-[10px] text-orange-500 font-bold">+ แถม ${g.freeItem}</p>` : ''}</div><button onclick="buyItem('${g.name}')" class="w-full mt-2 bg-purple-50 text-purple-600 hover:bg-purple-600 hover:text-white text-xs font-bold py-1.5 rounded transition">เติมเกม</button></div>
            </div>`).join('');
    }

    function buyItem(name) {
        if (!currentUser) {
            Swal.fire({ title: 'กรุณาเข้าสู่ระบบ', text: 'คุณต้องล็อกอินก่อนทำรายการ', icon: 'warning', confirmButtonText: 'เข้าสู่ระบบ', confirmButtonColor: '#181a20' }).then((res) => { if(res.isConfirmed) openAuthModal(); });
            return;
        }
        Swal.fire('ยืนยันคำสั่งซื้อ', `ต้องการซื้อ ${name} ใช่ไหม?<br>ระบบจะแจ้งเตือนทาง Line`, 'question');
    }

    // --- Auth Logic ---

    function openAuthModal() {
        document.getElementById('authModal').classList.remove('hidden');
        isLoginView = true;
        updateView();
    }
    function closeAuthModal() { document.getElementById('authModal').classList.add('hidden'); }
    function toggleMainView() { isLoginView = !isLoginView; updateView(); }

    function updateView() {
        const viewLogin = document.getElementById('view-login');
        const viewRegister = document.getElementById('view-register');
        const pageTitle = document.getElementById('page-title');
        const switchBtnText = document.getElementById('switch-btn-text');
        if (isLoginView) {
            viewLogin.classList.remove('hidden'); viewRegister.classList.add('hidden');
            pageTitle.innerText = "เข้าสู่ระบบ"; switchBtnText.innerText = "สมัครสมาชิก";
        } else {
            viewRegister.classList.remove('hidden'); viewLogin.classList.add('hidden');
            pageTitle.innerText = "สมัครสมาชิก"; switchBtnText.innerText = "เข้าสู่ระบบ";
        }
    }

    function switchLoginTab(tab) {
        if(tab === 'main') {
            document.getElementById('tab-login-main').classList.add('active');
            document.getElementById('tab-login-otp').classList.remove('active');
            document.getElementById('form-login-main').classList.remove('hidden');
            document.getElementById('form-login-otp').classList.add('hidden');
        } else {
            document.getElementById('tab-login-otp').classList.add('active');
            document.getElementById('tab-login-main').classList.remove('active');
            document.getElementById('form-login-otp').classList.remove('hidden');
            document.getElementById('form-login-main').classList.add('hidden');
        }
    }

    // Toggle Login Method (Email vs Phone)
    function toggleLoginMethod() {
        const method = document.getElementById('login-method-select').value;
        if (method === 'phone') {
            document.getElementById('input-group-email').classList.add('hidden');
            document.getElementById('input-group-phone').classList.remove('hidden');
        } else {
            document.getElementById('input-group-email').classList.remove('hidden');
            document.getElementById('input-group-phone').classList.add('hidden');
        }
    }

    function togglePass(id) {
        const el = document.getElementById(id);
        const icon = el.nextElementSibling;
        if(el.type === 'password') { el.type = 'text'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash', 'text-blue-400'); }
        else { el.type = 'password'; icon.classList.add('fa-eye'); icon.classList.remove('fa-eye-slash', 'text-blue-400'); }
    }

    // --- Backend Calls ---

    function requestOtp(emailId, btn) {
        const email = document.getElementById(emailId).value;
        if(!email) { Swal.fire('แจ้งเตือน', 'กรุณากรอกอีเมล', 'warning'); return; }
        const oldText = btn.innerText; btn.disabled = true; let count = 60;
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                Swal.fire({toast:true, position:'top-end', icon:'success', title:'ส่ง OTP แล้ว', timer:3000, showConfirmButton:false});
                const timer = setInterval(() => { btn.innerText = `รอ ${count}s`; count--; if(count < 0) { clearInterval(timer); btn.disabled=false; btn.innerText = "ส่งอีกครั้ง"; } }, 1000);
            } else { btn.disabled = false; btn.innerText = oldText; Swal.fire('Error', res.message, 'error'); }
        }).sendOtpEmail(email);
    }

    // Login with Email/Phone + Password
    function submitLogin() {
        const method = document.getElementById('login-method-select').value;
        const password = document.getElementById('login-pass').value;
        
        if (!password) return Swal.fire('แจ้งเตือน', 'กรุณากรอกรหัสผ่าน', 'warning');

        let payload = {};
        
        if (method === 'email') {
            const identifier = document.getElementById('login-username').value;
            if (!identifier) return Swal.fire('แจ้งเตือน', 'กรุณากรอกอีเมลหรือชื่อผู้ใช้', 'warning');
            payload = { type: 'email_password', identifier: identifier, password: password };
        } else {
            const phone = document.getElementById('login-phone').value;
            const country = document.getElementById('login-selected-name').innerText;
            if (!phone) return Swal.fire('แจ้งเตือน', 'กรุณากรอกเบอร์โทรศัพท์', 'warning');
            payload = { type: 'phone_password', country: country, phone: phone, password: password };
        }

        Swal.showLoading();
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                currentUser = res.user; Swal.close(); closeAuthModal(); updateUserUI();
                Swal.fire({icon:'success', title:'ยินดีต้อนรับ', text: `สวัสดีคุณ ${currentUser.email}`, timer:1500, showConfirmButton:false});
            } else { Swal.fire('เข้าสู่ระบบไม่สำเร็จ', res.message, 'error'); }
        }).loginUser(payload);
    }

    // Login with Email + OTP
    function submitLoginOtp() {
        const email = document.getElementById('login-otp-email').value;
        const otp = document.getElementById('login-otp-code').value;
        if (!email || !otp) return Swal.fire('แจ้งเตือน', 'กรุณากรอกข้อมูลให้ครบ', 'warning');
        
        Swal.showLoading();
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                currentUser = res.user; Swal.close(); closeAuthModal(); updateUserUI();
                Swal.fire({icon:'success', title:'ยินดีต้อนรับ', text: `สวัสดีคุณ ${currentUser.email}`, timer:1500, showConfirmButton:false});
            } else { Swal.fire('เข้าสู่ระบบไม่สำเร็จ', res.message, 'error'); }
        }).loginUser({ type: 'otp', identifier: email, otp: otp });
    }

    function submitRegister() {
        const payload = {
            email: document.getElementById('reg-email').value,
            lineId: document.getElementById('reg-line').value,
            phone: document.getElementById('reg-phone').value,
            country: document.getElementById('reg-selected-name').innerText,
            otp: document.getElementById('reg-otp').value,
            password: document.getElementById('reg-pass').value
        };
        if(!payload.email || !payload.otp || !payload.password) return Swal.fire('แจ้งเตือน','กรุณากรอกข้อมูลให้ครบ','warning');
        Swal.showLoading();
        google.script.run.withSuccessHandler(res => {
            if(res.success) { Swal.fire('สำเร็จ', 'สมัครสมาชิกเรียบร้อย โปรดล็อกอิน', 'success'); toggleMainView(); }
            else { Swal.fire('ผิดพลาด', res.message, 'error'); }
        }).registerUser(payload);
    }

    function updateUserUI() {
        document.getElementById('guestMenu').classList.add('hidden');
        document.getElementById('userMenu').classList.remove('hidden');
        document.getElementById('userMenu').classList.add('flex');
        document.getElementById('userNameDisplay').innerText = currentUser.email;
    }
    function logout() {
        currentUser = null;
        document.getElementById('guestMenu').classList.remove('hidden');
        document.getElementById('userMenu').classList.add('hidden');
        document.getElementById('userMenu').classList.remove('flex');
    }

    // --- Country Modal Logic (Shared) ---
    function openCountryModal(context) {
        currentCountryContext = context; // 'register' or 'login'
        document.getElementById('country-modal').classList.add('open');
        renderCountries(allCountries);
        document.getElementById('search-country').value = '';
    }
    function closeCountryModal() { document.getElementById('country-modal').classList.remove('open'); }
    function renderCountries(list) {
        document.getElementById('country-list-container').innerHTML = list.map(c => `
            <div class="country-list-item" onclick="selectCountry('${c.code}', '${c.name}', '${c.dial_code}')">
                <img src="https://flagcdn.com/w40/${c.code.toLowerCase()}.png" class="w-6 h-4 rounded-sm mr-3 shadow-sm">
                <div class="flex-1">
                    <div class="text-sm text-white font-medium">${c.name}</div>
                    <div class="text-xs text-gray-500">${c.code}</div>
                </div>
                <div class="text-sm text-[#4facfe] font-medium">${c.dial_code}</div>
            </div>`).join('');
    }
    function filterCountries() {
        const term = document.getElementById('search-country').value.toLowerCase();
        const filtered = allCountries.filter(c => c.name.toLowerCase().includes(term) || c.dial_code.includes(term));
        renderCountries(filtered);
    }
    function selectCountry(code, name, dial) {
        const prefix = currentCountryContext === 'login' ? 'login-' : 'reg-';
        document.getElementById(`${prefix}selected-flag`).src = `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
        document.getElementById(`${prefix}selected-code`).innerText = dial;
        document.getElementById(`${prefix}selected-name`).innerText = name;
        closeCountryModal();
    }
  </script>
</body>
</html>
